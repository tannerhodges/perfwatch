<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- TODO: Update Content Security Policy... -->
		<!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
		<!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'"> -->
		<!-- <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'self'"> -->

		<title>⏱️ perfwatch</title>

		<style>
			body {
				margin-block-end: 10rem;
			}

			table {
				table-layout: fixed;
				min-width: 15rem;
				border-collapse: collapse;
				font-variant-numeric: tabular-nums;
				text-align: left;
			}

			:where(th, td):last-child {
				text-align: right;
			}

			summary {
				margin-block: 0.5rem;
			}

			#folderButton {
				margin-inline-end: 0.25rem;
			}
		</style>

		<script>
			document.addEventListener('alpine:init', () => {
				Alpine.store('data', {
					events: [],
					fileChanges: [],
					folderPath: '',
				});
			});

			document.addEventListener('alpine:initialized', () => {
				Alpine.store('data', {
					events: Alpine.$persist([]).as('events'),
					fileChanges: Alpine.$persist([]).as('fileChanges'),
					folderPath: Alpine.$persist('').as('folderPath'),
				});
			});

			window.electronAPI.handleLog((data) => {
				Alpine.store('data').events.push(data);
			});

			window.electronAPI.handleFileChange((event, path) => {
				const timestamp = performance.timeOrigin + performance.now();
				Alpine.store('data').fileChanges.push({ timestamp, event, path });
			});
		</script>

		<script defer src="https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js"></script>
		<script defer src="https://unpkg.com/@alpinejs/persist@3.10.2/dist/cdn.min.js"></script>
		<script defer src="https://unpkg.com/alpinejs@3.10.2/dist/cdn.min.js"></script>
		<script defer src="./renderer.js"></script>
	</head>
	<body>
		<h1>⏱️ perfwatch</h1>

		<h2>Add script to your website</h2>
		<pre><code>&lt;!-- ⏱️ perfwatch - ONLY FOR LOCAL DEVELOPMENT --&gt;
&lt;script async src="http://localhost:1873/perfwatch.js"&gt;&lt;/script&gt;</code></pre>

		<h2>Select your project folder</h2>
		<div x-data="{
			async selectFolder() {
				$store.data.folderPath = await window.electronAPI.openFolder();
			},
		}">
			<button type="button" @click="selectFolder()">Select Folder</button>
			<strong x-text="$store.data.folderPath"></strong>
		</div>

		<h2>Load your website</h2>
		<p>Then check back here to see the results…</p>

		<div x-data="{
			metrics: [
				'TTFB',
				'FCP',
				'LCP',
				'FID',
				'CLS',
			],

			selectedMetric: $persist(''),

			reset() {
				$store.data.events = [];
				$store.data.fileChanges = [];
			},

			formatDateTime(timestamp) {
				return (new Date(timestamp)).toISOString();
			},

			getAverage(events) {
				return events.reduce((sum, e) => (sum + (e?.value || 0)), 0) / (events.length || 1);
			},

			getEventsGroupedByInstanceId() {
				const instanceEvents = $store.data.events.reduce((result, event) => {
					let instance = result.find(g => g.instanceId === event.instanceId);
					if (instance) {
						instance.events.push(event);
					} else {
						result.push({
							instanceId: event.instanceId,
							events: [event],
						});
					}
					return result;
				}, []);

				instanceEvents.sort((a, b) => a.instanceId - b.instanceId);

				return instanceEvents;
			},

			getChart(events = []) {
				const instanceEvents = this.getEventsGroupedByInstanceId();
				const labels = instanceEvents.map(i => i.instanceId);

				const datasets = this.metrics.map((metric) => ({
					label: metric,
					data: instanceEvents.map((instance) => {
						return instance.events.find(e => e.name === metric)?.value.toFixed(3);
					}),
				})).filter((dataset) => {
					return !this.selectedMetric || dataset.label === this.selectedMetric;
				});

				return { labels, datasets };
			},

			init() {
				const { labels, datasets } = this.getChart();
				const chart = new Chart(this.$refs.canvas.getContext('2d'), {
					type: 'line',
					data: { labels, datasets },
					options: {
						animation: false,
						interaction: { intersect: false },
						scales: { y: { beginAtZero: true } },
					}
				});

				Alpine.effect(() => {
					const events = $store.data.events.filter(e => e.name === 'TTFB');
					const { labels, datasets } = this.getChart(events);
					chart.data.labels = labels;
					chart.data.datasets = datasets;
					chart.update();
				});
			},
		}">
			<label for="selectedMetric">Filter by metric:</label>
			<select id="selectedMetric" x-model="selectedMetric">
				<option value="">View All</option>
				<option>TTFB</option>
				<option>FCP</option>
				<option>LCP</option>
				<option>FID</option>
				<option>CLS</option>
			</select>
			<button type="button" @click="reset()">Reset</button>

			<hr>

			<canvas x-ref="canvas" class="rounded-lg bg-white p-8"></canvas>

			<hr>

			<details>
				<summary>Show All Events</summary>
				<table cellpadding="5" border="1">
					<thead>
						<th>Metric</th>
						<th>Value</th>
					</thead>
					<tbody>
						<template x-for="event in $store.data.events">
							<tr x-show="!selectedMetric || selectedMetric === event.name">
								<td x-text="event.name"></td>
								<td x-text="event.value.toFixed(3)"></td>
							</tr>
						</template>
					</tbody>
					<tfoot>
						<template x-for="metric in ['TTFB', 'FCP', 'LCP', 'FID', 'CLS']">
							<tr x-show="!selectedMetric || selectedMetric === metric">
								<td x-text="`Average ${metric}`"></td>
								<td x-text="getAverage($store.data.events.filter(e => e.name === metric)).toFixed(3)"></td>
							</tr>
						</template>
					</tfoot>
				</table>
			</details>

			<details>
				<summary>Show File Changes</summary>
				<table cellpadding="5" border="1">
					<thead>
						<th>Timestamp</th>
						<th>Event</th>
						<th>Path</th>
					</thead>
					<tbody>
						<template x-for="fileChange in $store.data.fileChanges">
							<tr>
								<td x-text="formatDateTime(fileChange.timestamp)"></td>
								<td x-text="fileChange.event"></td>
								<td x-text="fileChange.path"></td>
							</tr>
						</template>
					</tbody>
				</table>
			</details>
		</div>
	</body>
</html>
